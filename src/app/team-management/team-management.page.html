<!-- Team Management Page Header -->
<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button [defaultHref]="ROUTES.TOURNAMENTS"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ TEXT.LABELS.PLAYER_REGISTER }}</ion-title>
  </ion-toolbar>
</ion-header>

<!-- Main Content Area -->
<ion-content color="light">
  <!-- Tab Segment for switching between Registrations and Teams -->
  <ion-segment
    [(ngModel)]="selectedTab"
    name="selectedTab"
    (ngModelChange)="onTabChange()"
    [class]="CSS_CLASSES.SEGMENT.CONTAINER"
    color="primary"
    mode="ios"
  >
    <!-- Registrations Tab -->
    <ion-segment-button [value]="TAB_VALUES.REGISTRATIONS">
      <div [class]="CSS_CLASSES.SEGMENT.BUTTON_CONTENT">
        <ion-label><h2>{{ TEXT.LABELS.REGISTRATIONS }}</h2></ion-label>
        <ion-badge
          color="tertiary"
          [class]="CSS_CLASSES.SEGMENT.BADGE"
        >
          {{ registrations.length }}
        </ion-badge>
      </div>
    </ion-segment-button>
    
    <!-- Teams Tab -->
    <ion-segment-button [value]="TAB_VALUES.TEAMS">
      <div [class]="CSS_CLASSES.SEGMENT.BUTTON_CONTENT">
        <ion-label><h2>{{ TEXT.LABELS.TEAMS }}</h2></ion-label>
        <ion-badge
          color="tertiary"
          [class]="CSS_CLASSES.SEGMENT.BADGE"
        >
          {{ teams.length }}
        </ion-badge>
      </div>
    </ion-segment-button>
  </ion-segment>

  <!-- Registrations Tab Content -->
  @if (isRegistrationsTab()) {
    <!-- Search Bar for Registrations -->
    @if (hasRegistrations()) {
      <ion-searchbar
        [(ngModel)]="searchText"
        name="searchText"
        [placeholder]="TEXT.PLACEHOLDERS.SEARCH_PLAYERS"
        show-clear-button="focus"
        [class]="CSS_CLASSES.SEARCH.BAR"
      ></ion-searchbar>
    }
  
    <!-- No Search Results Message -->
    @if (isNoSearchResults()) {
      <ion-text class="ion-margin-top">
        <h5 [class]="CSS_CLASSES.EMPTY_STATE.WARNING">
          <ion-text color="warning">
            <ion-icon [name]="ICONS.WARNING"></ion-icon>
          </ion-text>
          {{ TEXT.MESSAGES.NO_PLAYERS_FOUND }} "{{ searchText }}"
          <ion-icon color="danger" [name]="ICONS.SEARCH" [class]="CSS_CLASSES.EMPTY_STATE.ICON"></ion-icon>
        </h5>
      </ion-text>
    } 
    <!-- No Registrations Message -->
    @else if (isNoRegistrations()) {
      <ion-text class="ion-margin-top">
        <h5 [class]="CSS_CLASSES.EMPTY_STATE.WARNING">
          <ion-text color="danger">
            <ion-icon [name]="ICONS.PERSON" [class]="CSS_CLASSES.EMPTY_STATE.ICON"></ion-icon>
          </ion-text>
          {{ TEXT.MESSAGES.NO_REGISTRATIONS }}
        </h5>
      </ion-text>
    } 
    <!-- Registrations List -->
    @else {
      <ion-list [inset]="true" lines="full">
        @for (registration of filteredRegistrations; track registration.id) {
          <ion-item-sliding #slidingItem>
            <!-- Registration Item -->
            <ion-item [button]="true" detail="false">
              <!-- Player Avatar -->
              <div class="unread-indicator-wrapper" slot="start">
                <ion-avatar [class]="CSS_CLASSES.TEAM_MANAGEMENT.PLAYER_AVATAR">
                  <img 
                    [src]="getPlayerAvatarUrl(registration)" 
                    [alt]="registration.name" 
                  />
                </ion-avatar>
              </div>
              
              <!-- Player Information -->
              <ion-label>
                <strong>{{ registration.name }}</strong>
                <ion-text>{{ registration.email }}</ion-text><br />
                <ion-text [class]="CSS_CLASSES.TEAM_MANAGEMENT.PLAYER_INFO">
                  {{ registration.gender }}
                </ion-text>
                @if (registration.remarks) {
                  <ion-note color="medium" class="ion-text-wrap">
                    {{ registration.remarks }}
                  </ion-note>
                }
              </ion-label>
              
              <!-- Status Information -->
              <div [class]="CSS_CLASSES.TEAM_MANAGEMENT.METADATA_WRAPPER" slot="end">
                <ion-note color="medium">
                  <ion-chip 
                    [color]="getStatusColor(registration.status)" 
                    [class]="CSS_CLASSES.TEAM_MANAGEMENT.STATUS_CHIP"
                  >
                    <ion-icon [name]="getStatusIcon(registration.status)"></ion-icon>
                    <ion-label>{{ registration.status | titlecase }}</ion-label>
                  </ion-chip>
                </ion-note>
              </div>
            </ion-item>
            
            <!-- Action Options -->
            @if (canEdit) {
              <ion-item-options>
                @if (isPendingStatus(registration.status)) {
                  <ion-item-option 
                    (click)="handleApproveRegistration(slidingItem, registration)" 
                    color="success"
                  >
                    <ion-icon slot="icon-only" [name]="ICONS.CHECKMARK"></ion-icon>
                    {{ TEXT.LABELS.APPROVE }}
                  </ion-item-option>
                  <ion-item-option 
                    (click)="handleRejectRegistration(slidingItem, registration)" 
                    color="warning"
                  >
                    <ion-icon slot="icon-only" [name]="ICONS.CLOSE"></ion-icon>
                    {{ TEXT.LABELS.REJECT }}
                  </ion-item-option>
                }
                <ion-item-option 
                  (click)="handleDeleteRegistration(slidingItem, registration)" 
                  color="danger"
                >
                  <ion-icon slot="icon-only" [name]="ICONS.TRASH"></ion-icon>
                  {{ TEXT.LABELS.DELETE }}
                </ion-item-option>
              </ion-item-options>
            }
          </ion-item-sliding>
        }
      </ion-list>
    }
  }

  <!-- Teams Tab Content -->
  @if (isTeamsTab()) {
    <!-- Search Bar for Teams -->
    @if (hasTeams()) {
      <ion-searchbar
        [(ngModel)]="searchText"
        name="searchText"
        [placeholder]="TEXT.PLACEHOLDERS.SEARCH_TEAMS"
        show-clear-button="focus"
        [class]="CSS_CLASSES.SEARCH.BAR"
      ></ion-searchbar>
    }
  
    <!-- No Search Results Message -->
    @if (isNoTeamSearchResults()) {
      <ion-text class="ion-margin-top">
        <h5 [class]="CSS_CLASSES.EMPTY_STATE.WARNING">
          <ion-text color="warning">
            <ion-icon [name]="ICONS.WARNING"></ion-icon>
          </ion-text>
          {{ TEXT.MESSAGES.NO_TEAMS_FOUND }} "{{ searchText }}"
          <ion-icon color="danger" [name]="ICONS.SEARCH" [class]="CSS_CLASSES.EMPTY_STATE.ICON"></ion-icon>
        </h5>
      </ion-text>
    } 
    <!-- No Teams Message -->
    @else if (isNoTeams()) {
      <ion-text class="ion-margin-top">
        <h5 [class]="CSS_CLASSES.EMPTY_STATE.WARNING">
          <ion-text color="danger">
            <ion-icon [name]="ICONS.PERSON" [class]="CSS_CLASSES.EMPTY_STATE.ICON"></ion-icon>
          </ion-text>
          {{ TEXT.MESSAGES.NO_REGISTRATIONS }}
        </h5>
      </ion-text>
    } 
    <!-- Teams List -->
    @else {
      <ion-list [inset]="true" lines="full">
        @for (team of filteredTeams; track team.id) {
          <ion-item-sliding #slidingItem>
            <!-- Team Item -->
            <ion-item [button]="true" detail="false">
              <ion-label>
                <!-- Team Name -->
                <strong [class]="CSS_CLASSES.TEAM_MANAGEMENT.TEAM_TITLE">
                  {{ TEXT.LABELS.TEAM_PREFIX }}: {{ team.name }}
                </strong>
                
                <!-- Player Names Preview -->
                @if (team.players.length > 0) {
                  <ion-note>
                    <span [class]="CSS_CLASSES.TEAM_MANAGEMENT.PLAYERS_TEXT">
                      {{ TEXT.LABELS.PLAYERS_PREFIX }}:
                    </span>
                    @for (player of getPreviewPlayers(team.players); track player.userId; let isLast = $last) {
                      <span [class]="CSS_CLASSES.TEAM_MANAGEMENT.PLAYER_NAME">
                        {{ player.name }}{{ getPlayerSeparator(isLast, team.players.length) }}
                      </span>
                    }
                    @if (hasMorePlayers(team.players.length)) {
                      <span [class]="CSS_CLASSES.TEAM_MANAGEMENT.MORE_PLAYERS">
                        {{ getMorePlayersText(team.players.length) }}
                      </span>
                    }
                  </ion-note>
                }
              </ion-label>
              
              <!-- Team Status -->
              <div [class]="CSS_CLASSES.TEAM_MANAGEMENT.METADATA_WRAPPER" slot="end">
                <ion-note color="medium">
                  @if (isActiveTeam(team.players.length)) {
                    <ion-chip color="success" [class]="CSS_CLASSES.TEAM_MANAGEMENT.DETAIL_CHIP">
                      <ion-icon [name]="ICONS.CHECKMARK_CIRCLE"></ion-icon>
                      <ion-label>{{ TEXT.LABELS.ACTIVE }}</ion-label>
                    </ion-chip>
                  } @else {
                    <ion-chip color="warning" [class]="CSS_CLASSES.TEAM_MANAGEMENT.DETAIL_CHIP">
                      <ion-icon [name]="ICONS.TIME"></ion-icon>
                      <ion-label>{{ TEXT.LABELS.EMPTY }}</ion-label>
                    </ion-chip>
                  }
                </ion-note>
              </div>
            </ion-item>
            
            <!-- Team Action Options -->
            @if (canEdit) {
              <ion-item-options>
                <ion-item-option 
                  (click)="handleEditTeam(slidingItem, team)" 
                  color="success"
                >
                  <ion-icon slot="icon-only" [name]="ICONS.CHECKMARK"></ion-icon>
                  {{ TEXT.LABELS.EDIT_TEAM }}
                </ion-item-option>
                <ion-item-option 
                  (click)="handleDeleteTeam(slidingItem, team)" 
                  color="warning"
                >
                  <ion-icon slot="icon-only" [name]="ICONS.CLOSE"></ion-icon>
                  {{ TEXT.LABELS.DELETE_TEAM }}
                </ion-item-option>
              </ion-item-options>
            }
          </ion-item-sliding>
        }
      </ion-list>
    }

    <!-- Add Team Button -->
    @if (canEdit) {
      <ion-button
        (click)="openTeamModal()"
        color="primary"
        size="default"
        expand="block"
        [class]="CSS_CLASSES.BUTTONS.ADD_TEAM + ' ion-margin-top'"
      >
        <ion-icon [name]="ICONS.ADD" slot="start"></ion-icon>
        {{ TEXT.LABELS.ADD_TEAM }}
      </ion-button>
    }
  }



  <!-- Team Creation/Edit Modal -->
  <ion-modal
    [isOpen]="showTeamModal"
    (didDismiss)="onModalDismiss()"
    class="team-modal"
  >
    <ng-template>
      <!-- Modal Header -->
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>
            <ion-icon
              [name]="getModalIcon()"
              [class]="CSS_CLASSES.MODAL.TITLE_ICON"
            ></ion-icon>
            {{ getModalTitle() }}
          </ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal()">
              <ion-icon [name]="ICONS.CLOSE"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <!-- Modal Content -->
      <ion-content [class]="CSS_CLASSES.MODAL.CONTENT">
        <div [class]="CSS_CLASSES.MODAL.CONTAINER + ' ion-padding'">
          <form #teamForm="ngForm" (ngSubmit)="saveTeam()">
            <!-- Team Name Input Section -->
            <ion-input
              fill="outline"
              [(ngModel)]="currentTeam.name"
              [label]="TEXT.LABELS.TEAM_NAME"
              name="teamName"
              required
              label-placement="floating"
              class="ion-margin-bottom ion-margin-top"
              [placeholder]="TEXT.PLACEHOLDERS.TEAM_NAME"
              [maxlength]="UI_CONSTANTS.MODAL.MAX_LENGTH.TEAM_NAME"
            ></ion-input>
            
            <!-- Player Selection Section -->
            @if (hasAvailablePlayers()) {
              <h3 [class]="CSS_CLASSES.MODAL.SECTION_SUBTITLE">
                <ion-icon
                  [name]="ICONS.PERSON"
                  [class]="CSS_CLASSES.MODAL.SUBTITLE_ICON"
                ></ion-icon>
                {{ TEXT.LABELS.SELECT_PLAYERS }}
              </h3>
            }

            <!-- No Available Players Message -->
            @if (isNoAvailablePlayers()) {
              <div [class]="CSS_CLASSES.EMPTY_STATE.CONTAINER">
                <ion-text class="ion-margin-top">
                  <h5 [class]="CSS_CLASSES.EMPTY_STATE.WARNING">
                    <ion-text color="warning">
                      <ion-icon [name]="ICONS.WARNING"></ion-icon>
                    </ion-text>
                    {{ TEXT.MESSAGES.NO_AVAILABLE_PLAYERS }}
                  </h5>
                </ion-text>
              </div>
            } 
            <!-- Available Players List -->
            @else {
              <ion-list [class]="CSS_CLASSES.PLAYER_SELECTION.LIST + ' ion-margin-top'">
                @for (registration of availableRegistrations; track registration.id) {
                  <ion-item 
                    (click)="togglePlayerSelection(registration)"
                    [class]="CSS_CLASSES.PLAYER_SELECTION.ITEM"
                    [button]="true" 
                    detail="false" 
                    lines="full"
                  >
                    <!-- Selection Checkbox -->
                    <ion-checkbox
                      slot="end"
                      [checked]="isPlayerSelected(registration)"
                      color="primary"
                      [class]="'pointer-events-none'"
                    ></ion-checkbox>

                    <!-- Player Avatar -->
                    <div [class]="CSS_CLASSES.PLAYER_SELECTION.AVATAR_WRAPPER" slot="start">
                      <ion-avatar [class]="CSS_CLASSES.TEAM_MANAGEMENT.PLAYER_AVATAR">
                        <img 
                          [src]="getPlayerAvatarUrl(registration)" 
                          [alt]="registration.name" 
                        />
                      </ion-avatar>
                    </div>
                    
                    <!-- Player Information -->
                    <ion-label>
                      <strong>{{ registration.name }}</strong>
                      <ion-text>{{ registration.email }}</ion-text><br />
                      <ion-text [class]="CSS_CLASSES.TEAM_MANAGEMENT.PLAYER_INFO">
                        {{ registration.gender }}
                      </ion-text>
                      @if (registration.remarks) {
                        <ion-note color="medium" class="ion-text-wrap">
                          {{ registration.remarks }}
                        </ion-note>
                      }
                    </ion-label>
                  </ion-item>
                }
              </ion-list>
            }

            <!-- Modal Action Buttons -->
            <div [class]="CSS_CLASSES.MODAL.ACTIONS">
              <div [class]="CSS_CLASSES.BUTTONS.ACTION_ROW">
                <!-- Save Button -->
                <ion-button
                  type="submit"
                  [disabled]="!teamForm.valid"
                  color="primary"
                  [class]="CSS_CLASSES.BUTTONS.SAVE"
                >
                  <ion-icon
                    [name]="getSaveButtonIcon()"
                    slot="start"
                  ></ion-icon>
                  {{ getSaveButtonText() }}
                </ion-button>

                <!-- Cancel Button -->
                <ion-button
                  fill="outline"
                  color="dark"
                  (click)="closeModal()"
                  [class]="CSS_CLASSES.BUTTONS.CANCEL"
                >
                  {{ TEXT.LABELS.CANCEL }}
                </ion-button>
              </div>
            </div>
          </form>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
